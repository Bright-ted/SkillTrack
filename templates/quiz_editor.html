<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Quiz | SkillTrack</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script>
        // --- ADD MODE LOGIC (Switch tabs in the "Add" form) ---
        function setType(type) {
            document.getElementById('typeInput').value = type;
            
            // Visual Tabs
            ['tabMCQ', 'tabFill', 'tabTheory'].forEach(id => {
                document.getElementById(id).classList.remove('bg-indigo-600', 'text-white');
                document.getElementById(id).classList.add('bg-slate-100', 'text-slate-500');
            });

            // Active Tab
            let activeTab = type === 'MCQ' ? 'tabMCQ' : (type === 'FILL_BLANK' ? 'tabFill' : 'tabTheory');
            document.getElementById(activeTab).classList.add('bg-indigo-600', 'text-white');
            document.getElementById(activeTab).classList.remove('bg-slate-100', 'text-slate-500');

            // Toggle Fields Visibility
            document.getElementById('mcqFields').style.display = type === 'MCQ' ? 'block' : 'none';
            document.getElementById('fillFields').style.display = type === 'FILL_BLANK' ? 'block' : 'none';
            document.getElementById('theoryFields').style.display = type === 'THEORY' ? 'block' : 'none';
        }

        // --- EDIT MODE LOGIC (Populate Modal) ---
        function openEditModal(q) {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            
            // Set the form action dynamically to the correct Question ID
            form.action = `/instructor/edit_question/${q.id}`;
            
            // Fill Basic Data
            document.getElementById('edit_quiz_id').value = q.quiz_id;
            document.getElementById('edit_type_display').innerText = q.question_type;
            document.getElementById('edit_question_type').value = q.question_type;
            document.getElementById('edit_question_text').value = q.question_text;

            // Hide all specific sections first
            document.getElementById('edit_mcq').style.display = 'none';
            document.getElementById('edit_fill').style.display = 'none';
            document.getElementById('edit_theory').style.display = 'none';

            // Show relevant section and fill data based on type
            if(q.question_type === 'MCQ') {
                document.getElementById('edit_mcq').style.display = 'block';
                document.getElementById('edit_opt_a').value = q.option_a;
                document.getElementById('edit_opt_b').value = q.option_b;
                document.getElementById('edit_opt_c').value = q.option_c;
                document.getElementById('edit_opt_d').value = q.option_d;
                document.getElementById('edit_correct_opt').value = q.correct_option;
            } 
            else if(q.question_type === 'FILL_BLANK') {
                document.getElementById('edit_fill').style.display = 'block';
                document.getElementById('edit_correct_text').value = q.correct_option;
            } 
            else if(q.question_type === 'THEORY') {
                document.getElementById('edit_theory').style.display = 'block';
                document.getElementById('edit_keywords').value = q.keywords;
            }

            modal.style.display = 'flex';
        }

        function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
        }
    </script>
</head>
<body class="bg-slate-50 min-h-screen font-sans">

    <nav class="bg-white px-6 py-4 shadow-sm border-b border-slate-200 flex items-center gap-4">
        <a href="/instructor/course/{{ quiz.courses.id }}" class="text-slate-400 hover:text-slate-600 transition">
            <i class="ph-bold ph-arrow-left text-xl"></i>
        </a>
        <div>
            <h1 class="font-bold text-xl text-slate-800">Editing: {{ quiz.title }}</h1>
            <p class="text-xs text-slate-500">{{ quiz.courses.title }}</p>
        </div>
    </nav>

    <div class="max-w-6xl mx-auto mt-6 px-6">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="p-3 mb-2 rounded-lg border text-sm font-bold {% if category == 'success' %} bg-green-50 border-green-200 text-green-700 {% else %} bg-red-50 border-red-200 text-red-700 {% endif %}">
                  {{ message }}
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
    </div>

    <div class="max-w-6xl mx-auto mt-4 p-6 grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        <div class="lg:col-span-1">
            <div class="bg-white p-6 rounded-2xl shadow-md border border-slate-100 sticky top-6">
                <h3 class="font-bold text-lg text-slate-800 mb-4">Add New Question</h3>
                
                <div class="flex bg-slate-100 p-1 rounded-lg mb-6 text-center">
                    <button id="tabMCQ" onclick="setType('MCQ')" class="flex-1 py-2 text-xs font-bold rounded-md bg-indigo-600 text-white transition">MCQ</button>
                    <button id="tabFill" onclick="setType('FILL_BLANK')" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 transition">Fill Blank</button>
                    <button id="tabTheory" onclick="setType('THEORY')" class="flex-1 py-2 text-xs font-bold rounded-md text-slate-500 transition">Theory</button>
                </div>

                <form action="/instructor/add_question/{{ quiz.id }}" method="POST" class="space-y-4">
                    <input type="hidden" name="question_type" id="typeInput" value="MCQ">

                    <div>
                        <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Question</label>
                        <textarea name="question_text" rows="3" required class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type question here..."></textarea>
                    </div>

                    <div id="mcqFields" class="space-y-3">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" name="option_a" placeholder="Option A" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <input type="text" name="option_b" placeholder="Option B" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <input type="text" name="option_c" placeholder="Option C" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                            <input type="text" name="option_d" placeholder="Option D" class="w-full p-2 border border-slate-300 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Correct Option</label>
                            <select name="correct_option" class="w-full p-2 border border-slate-300 rounded-lg bg-white">
                                <option value="A">Option A</option>
                                <option value="B">Option B</option>
                                <option value="C">Option C</option>
                                <option value="D">Option D</option>
                            </select>
                        </div>
                    </div>

                    <div id="fillFields" class="space-y-3 hidden">
                        <div class="p-3 bg-blue-50 text-blue-700 text-xs rounded-lg mb-2">Use underscores (___) for blanks.</div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Correct Answer</label>
                            <input type="text" name="correct_text" placeholder="e.g. Paris" class="w-full p-3 border border-slate-300 rounded-lg text-sm">
                        </div>
                    </div>

                    <div id="theoryFields" class="space-y-3 hidden">
                        <div class="p-3 bg-yellow-50 text-yellow-800 text-xs rounded-lg mb-2">Separate keywords with commas.</div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Keywords</label>
                            <textarea name="keywords" rows="2" placeholder="e.g. sunlight, energy" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></textarea>
                        </div>
                    </div>

                    <button type="submit" class="w-full py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition shadow-lg shadow-indigo-200 mt-4">
                        <i class="ph-bold ph-plus-circle"></i> Add Question
                    </button>
                </form>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-4">
            {% if questions|length == 0 %}
                <div class="text-center py-20 bg-white rounded-2xl border border-dashed border-slate-300">
                    <p class="text-slate-500">No questions yet.</p>
                </div>
            {% endif %}

            {% for q in questions %}
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100 relative group hover:shadow-md transition">
                
                <div class="absolute top-4 right-4 flex gap-2">
                    <button onclick='openEditModal({{ q | tojson | safe }})' class="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 rounded-lg hover:bg-indigo-50 transition" title="Edit">
                        <i class="ph-bold ph-pencil-simple"></i>
                    </button>
                    <a href="/instructor/delete_question/{{ q.id }}" onclick="return confirm('Are you sure you want to delete this question? This cannot be undone.')" class="p-2 text-slate-400 hover:text-red-600 bg-slate-50 rounded-lg hover:bg-red-50 transition" title="Delete">
                        <i class="ph-bold ph-trash"></i>
                    </a>
                </div>

                <span class="text-xs font-bold px-2 py-1 rounded bg-slate-100 text-slate-500 uppercase mb-2 inline-block">
                    {{ q.question_type }}
                </span>

                <h4 class="font-bold text-lg text-slate-800 mb-3 pr-20">
                    <span class="text-slate-400 mr-2">Q{{ loop.index }}.</span> {{ q.question_text }}
                </h4>

                {% if q.question_type == 'MCQ' %}
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="p-2 border rounded {% if q.correct_option == 'A' %} bg-green-50 border-green-200 text-green-700 font-bold {% endif %}">A) {{ q.option_a }}</div>
                        <div class="p-2 border rounded {% if q.correct_option == 'B' %} bg-green-50 border-green-200 text-green-700 font-bold {% endif %}">B) {{ q.option_b }}</div>
                        <div class="p-2 border rounded {% if q.correct_option == 'C' %} bg-green-50 border-green-200 text-green-700 font-bold {% endif %}">C) {{ q.option_c }}</div>
                        <div class="p-2 border rounded {% if q.correct_option == 'D' %} bg-green-50 border-green-200 text-green-700 font-bold {% endif %}">D) {{ q.option_d }}</div>
                    </div>
                {% elif q.question_type == 'FILL_BLANK' %}
                    <div class="p-3 bg-blue-50 text-blue-700 text-sm rounded-lg border border-blue-100">
                        <strong>Answer:</strong> {{ q.correct_option }}
                    </div>
                {% elif q.question_type == 'THEORY' %}
                    <div class="p-3 bg-yellow-50 text-yellow-800 text-sm rounded-lg border border-yellow-100">
                        <strong>Keywords:</strong> {{ q.keywords }}
                    </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>

    <div id="editModal" class="fixed inset-0 bg-slate-900/50 hidden items-center justify-center z-50 backdrop-blur-sm" style="display: none;">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
            <div class="bg-indigo-600 p-4 flex justify-between items-center text-white">
                <h3 class="font-bold">Edit <span id="edit_type_display"></span> Question</h3>
                <button onclick="closeEditModal()" class="hover:text-indigo-200"><i class="ph-bold ph-x text-lg"></i></button>
            </div>
            
            <form id="editForm" method="POST" class="p-6 space-y-4">
                <input type="hidden" name="quiz_id" id="edit_quiz_id">
                <input type="hidden" name="question_type" id="edit_question_type">

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Question</label>
                    <textarea name="question_text" id="edit_question_text" rows="3" required class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>

                <div id="edit_mcq" class="space-y-3">
                    <div class="grid grid-cols-2 gap-2">
                        <input type="text" name="option_a" id="edit_opt_a" class="w-full p-2 border border-slate-300 rounded text-sm">
                        <input type="text" name="option_b" id="edit_opt_b" class="w-full p-2 border border-slate-300 rounded text-sm">
                        <input type="text" name="option_c" id="edit_opt_c" class="w-full p-2 border border-slate-300 rounded text-sm">
                        <input type="text" name="option_d" id="edit_opt_d" class="w-full p-2 border border-slate-300 rounded text-sm">
                    </div>
                    <label class="block text-xs font-bold text-slate-500 uppercase">Correct Option</label>
                    <select name="correct_option" id="edit_correct_opt" class="w-full p-2 border border-slate-300 rounded bg-white">
                        <option value="A">Option A</option>
                        <option value="B">Option B</option>
                        <option value="C">Option C</option>
                        <option value="D">Option D</option>
                    </select>
                </div>

                <div id="edit_fill" class="space-y-3 hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Correct Answer</label>
                    <input type="text" name="correct_text" id="edit_correct_text" class="w-full p-3 border border-slate-300 rounded-lg text-sm">
                </div>

                <div id="edit_theory" class="space-y-3 hidden">
                    <label class="block text-xs font-bold text-slate-500 uppercase">Keywords</label>
                    <textarea name="keywords" id="edit_keywords" rows="2" class="w-full p-3 border border-slate-300 rounded-lg text-sm"></textarea>
                </div>

                <div class="pt-2 flex gap-3">
                    <button type="button" onclick="closeEditModal()" class="flex-1 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition">Cancel</button>
                    <button type="submit" class="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl hover:bg-indigo-700 transition">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

</body>
</html>