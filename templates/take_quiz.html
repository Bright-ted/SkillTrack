<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ quiz.title }}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style> 
        body { 
            user-select: none; 
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }
        /* Prevent copy/paste */
        * {
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        input, textarea {
            user-select: text !important;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-24" oncontextmenu="return false;">

    <!-- Top Bar -->
    <div class="fixed top-0 w-full bg-white border-b border-slate-200 z-50 px-4 py-3 flex justify-between items-center shadow-sm">
        <div>
            <h1 class="font-bold text-slate-800 text-sm md:text-base">{{ quiz.title }}</h1>
            <p class="text-xs text-slate-500">Exam Mode</p>
        </div>
        <div class="bg-indigo-600 text-white px-4 py-1.5 rounded-lg font-mono font-bold text-lg shadow-lg shadow-indigo-200">
            <span id="timer">00:00</span>
        </div>
    </div>

    <!-- Questions Container -->
    <div class="max-w-3xl mx-auto mt-20 px-4">
        <form id="quizForm" action="/student/submit_quiz/{{ quiz.id }}" method="POST">
            <input type="hidden" name="final_answers" id="finalAnswersInput">
            <input type="hidden" name="violation_count" id="violationCountInput" value="0">

            {% for q in questions %}
            <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 mb-6" id="question-{{ q.id }}">
                <span class="inline-block bg-slate-100 text-slate-500 text-xs font-bold px-2 py-1 rounded mb-3">
                    Question {{ loop.index }}
                </span>
                
                <h3 class="text-lg font-bold text-slate-800 mb-4">{{ q.text }}</h3>

                {% if q.question_type == 'MCQ' %}
                <div class="space-y-3">
                    {% for opt in q.options %}
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-lg cursor-pointer hover:bg-indigo-50 transition question-option">
                        <input type="radio" 
                               name="question_{{ q.id }}" 
                               value="{{ opt.code }}" 
                               onchange="saveAnswer('{{ q.id }}', '{{ opt.code }}')" 
                               class="w-5 h-5 text-indigo-600 question-radio">
                        <span class="text-slate-700">{{ opt.text }}</span>
                    </label>
                    {% endfor %}
                </div>
                {% endif %}

                {% if q.question_type == 'FILL_BLANK' %}
                <input type="text" 
                       name="question_{{ q.id }}"
                       oninput="saveAnswer('{{ q.id }}', this.value)" 
                       placeholder="Type your answer here..." 
                       class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200">
                {% endif %}

                {% if q.question_type == 'THEORY' %}
                <textarea name="question_{{ q.id }}"
                          oninput="saveAnswer('{{ q.id }}', this.value)"
                          placeholder="Type your answer here..."
                          rows="4"
                          class="w-full p-3 border border-slate-300 rounded-lg outline-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200"></textarea>
                {% endif %}
            </div>
            {% endfor %}
        </form>
    </div>

    <!-- Submit Button -->
    <div class="fixed bottom-0 w-full bg-white border-t border-slate-200 p-4 z-50">
        <button type="button" onclick="submitExam()" 
                class="w-full md:max-w-md mx-auto block bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-indigo-700 transition">
            Submit Exam
        </button>
    </div>

    <!-- Warning Modal -->
    <div id="warningModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-sm mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center text-yellow-600 text-2xl mx-auto mb-4">
                    <i class="ph-bold ph-warning"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-800 mb-2" id="warningTitle">Warning</h3>
                <p class="text-slate-600 mb-4" id="warningMessage"></p>
                <button onclick="closeWarning()" class="w-full py-2 bg-indigo-600 text-white rounded-lg font-bold">
                    OK
                </button>
            </div>
        </div>
    </div>

    <script>
        // ========== QUIZ STATE ==========
        let answers = {};
        let isSubmitting = false;
        let violationCount = 0;
        const MAX_VIOLATIONS = 3;
        let timeLeft = {{ quiz.duration_minutes }} * 60;
        
        // ========== TAB SWITCH DETECTION ==========
        document.addEventListener('visibilitychange', function() {
            if (document.hidden && !isSubmitting) {
                violationCount++;
                document.getElementById('violationCountInput').value = violationCount;
                
                if (violationCount >= MAX_VIOLATIONS) {
                    showWarning("Quiz Terminated", 
                               "You switched tabs too many times. Quiz will be submitted automatically.");
                    setTimeout(() => {
                        submitExam();
                    }, 2000);
                } else {
                    showWarning(`Warning ${violationCount}/${MAX_VIOLATIONS}`, 
                               "Please do not switch tabs or windows during the exam.");
                }
            }
        });

        // ========== ANTI-CHEATING MEASURES ==========
        // Disable right-click
        document.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            return false;
        });

        // Disable keyboard shortcuts for copy/paste
        document.addEventListener('keydown', function(e) {
            // Ctrl+C, Ctrl+V, Ctrl+X
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'v' || e.key === 'x')) {
                e.preventDefault();
                showWarning("Action Restricted", "Copy/paste is disabled during the exam.");
            }
            // F5 refresh
            if (e.key === 'F5') {
                e.preventDefault();
                showWarning("Refresh Blocked", "You cannot refresh the page during the exam.");
            }
        });

        // ========== TIMER ==========
        function updateTimer() {
            if (timeLeft <= 0) {
                showWarning("Time's Up!", "Your quiz will be submitted automatically.");
                setTimeout(() => submitExam(), 1500);
                return;
            }
            
            let minutes = Math.floor(timeLeft / 60);
            let seconds = timeLeft % 60;
            document.getElementById('timer').textContent = 
                `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            timeLeft--;
        }
        
        // Update timer every second
        setInterval(updateTimer, 1000);
        updateTimer(); // Initial call

        // ========== ANSWER MANAGEMENT ==========
        function saveAnswer(questionId, answer) {
            answers[questionId] = answer;
            
            // Visual feedback for MCQ selection
            const questionDiv = document.getElementById(`question-${questionId}`);
            if (questionDiv) {
                // Remove selected class from all options
                const allOptions = questionDiv.querySelectorAll('.question-option');
                allOptions.forEach(opt => {
                    opt.classList.remove('bg-indigo-50', 'border-indigo-300');
                });
                
                // Add selected class to chosen option
                const selectedRadio = questionDiv.querySelector(`input[value="${answer}"]`);
                if (selectedRadio && selectedRadio.parentElement) {
                    selectedRadio.parentElement.classList.add('bg-indigo-50', 'border-indigo-300');
                }
            }
        }

        // ========== SUBMIT FUNCTION ==========
        function submitExam() {
            if (isSubmitting) return; // Prevent double submission
            
            isSubmitting = true;
            
            // Validate at least some answers are filled
            const answeredCount = Object.keys(answers).length;
            const totalQuestions = {{ questions|length }};
            
            if (answeredCount === 0) {
                if (!confirm("You haven't answered any questions. Submit anyway?")) {
                    isSubmitting = false;
                    return;
                }
            } else if (answeredCount < totalQuestions) {
                if (!confirm(`You've answered ${answeredCount} out of ${totalQuestions} questions. Submit anyway?`)) {
                    isSubmitting = false;
                    return;
                }
            }
            
            // Prepare final submission
            document.getElementById('finalAnswersInput').value = JSON.stringify(answers);
            document.getElementById('quizForm').submit();
        }

        // ========== WARNING MODAL ==========
        function showWarning(title, message) {
            document.getElementById('warningTitle').textContent = title;
            document.getElementById('warningMessage').textContent = message;
            document.getElementById('warningModal').classList.remove('hidden');
        }

        function closeWarning() {
            document.getElementById('warningModal').classList.add('hidden');
        }

        // ========== AUTO-SAVE PROGRESS ==========
        setInterval(() => {
            if (Object.keys(answers).length > 0 && !isSubmitting) {
                // You can implement auto-save to backend here
                console.log('Auto-saving progress...', answers);
            }
        }, 30000); // Every 30 seconds
    </script>
</body>
</html>